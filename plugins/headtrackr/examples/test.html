<!doctype html><title>Minimal tQuery Page</title>
<script src="../../../build/tquery-bundle-require.js"></script>
<script src="../vendor/headtrackr.js"></script>
<style>
#htrackerView {
        transform: scaleX(-1);
        -moz-transform: scaleX(-1);
        -o-transform: scaleX(-1);
        -webkit-transform: scaleX(-1);
}
</style>
<body><div id="info">
	Example of tQuery.headtrackr plugin
	-
	<a href='https://github.com/mrdoob/three.js/' target='_blank'>three.js</a>
	+
	<a href='http://jeromeetienne.github.com/tquery/'>tQuery API</a>
	for 3D
	/
	<a href='https://github.com/auduno/headtrackr' target='_blank'>headtrackr.js</a> for headtracking
	<br/>
	press [space] to reset head tracking
</div>
<canvas id="htrackerView" width="320" height="240"  style='position: absolute; top: 0; left: 0; z-index:1'></canvas>
<script>
require(['tquery.skymap', 'tquery.lensflare'], function(){
	var world	= tQuery.createWorld().boilerplate().pageTitle('#info').start();

	// tune initial camera position
	var cameraZ	= 2;
	world.removeCameraControls();	
	world.tCamera().position.z	= cameraZ;
	
	// add a skymap
	var skymap	= tQuery.createSkymap('skybox').addTo(world);

	// add some lensflare 
	tQuery.createLensFlare().addTo(world)
		.position(+1.4, 1, -3)
	tQuery.createLensFlare().addTo(world)
		.position(-1.4, 1, -3)
		
	var loader	= new THREE.BinaryLoader( true );
	loader.load("../../assets/obj/walt/WaltHead_bin.js", function(tGeometry){
		// normalize the geometry
		var geometry	= tQuery(tGeometry)
					.computeAll().normalize()
					.computeAll();
		// create the material
		var cubeTexture	= tQuery.createCubeTexture('swedishRoyalCastle');
		var material	= tQuery.createMeshBasicMaterial().envMap(cubeTexture);
		
		
		tQuery(geometry, tMaterial).addTo(world)
		for(var i = 0; i < 5; i++){
			tQuery(geometry, tMaterial).addTo(world)
				.positionX( i * 0.4)
				.positionZ(-i * 0.5)
			tQuery(geometry, tMaterial).addTo(world)
				.positionX(-i * 0.4)
				.positionZ(-i * 0.5)
		}
	});
	
	document.addEventListener("facetrackingEvent", function( event ) {
		if( event.detection !== 'CS' )	return;
		
		var normalizedX	= (event.x-160)/160;
		
		var angle	= Math.PI/3 * normalizedX + Math.PI/2;
		
		var tCamera	= world.tCamera();
		tCamera.position.x	= Math.cos(angle)*cameraZ;
		tCamera.position.z	= Math.sin(angle)*cameraZ;
		var target	= tQuery.createVector3(0,0,0);
		tCamera.lookAt(target);
	});	


	// create videoInput element to read the webcam
	var videoInput	= document.createElement('video');
	videoInput.setAttribute('autoplay');
	videoInput.setAttribute('loop');
	videoInput.setAttribute('width'	, '320');
	videoInput.setAttribute('height', '240');
	videoInput.style.display	= 'none';

	// create canvasInput element to read the webcam
	var canvasInput	= document.createElement('canvas');
	canvasInput.setAttribute('width', '320');
	canvasInput.setAttribute('height', '240');
	canvasInput.style.display	= 'none';

	
	var htracker	= new headtrackr.Tracker();
	htracker.init(videoInput, canvasInput);
	htracker.start();

	// reset if space is pressed
	document.addEventListener('keydown', function(event){
		// only if the key is space
		if( event.keyCode !== ' '.charCodeAt(0) )	return;
		// reset the head tracker
		htracker.stop();
		htracker.start();		
	})
	
	var canvasView	= document.getElementById('htrackerView');
	document.addEventListener("facetrackingEvent", function( event ) {
		// clear canvas
		var context = canvasView.getContext('2d');
		context.drawImage(videoInput, 0, 0, 320, 240);
		// once we have stable tracking, draw rectangle
		if( event.detection === 'CS' ){
			context.save();
			context.translate(event.x, event.y)
			context.rotate(event.angle - Math.PI/2);

			context.strokeStyle	= '#00CC00';
			context.strokeRect(Math.floor(-event.width/2), Math.floor(-event.height/2)
					, event.width, event.height);
			context.restore();
		}
	});	
});
</script></body>