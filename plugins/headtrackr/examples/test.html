<!doctype html><title>Minimal tQuery Page</title>
<script src="../../../build/tquery-bundle-require.js"></script>
<script src="../vendor/headtrackr.js"></script>
<style>
#overlay {
        transform: scaleX(-1);
        -moz-transform: scaleX(-1);
        -o-transform: scaleX(-1);
        -webkit-transform: scaleX(-1);
}
</style>
<body><div id="info">
	Example of tQuery.headtrackr plugin<br/>
	press space to reset head tracking
</div>
<canvas id="overlay" width="320" height="240"  style='position: absolute; top: 0; left: 0; z-index:1'></canvas>

<video id="vid" autoplay loop width="320" height="240" style='display:none'></video>

<canvas id="compare" width="320" height="240"  style='display:none'></canvas>
<script>
require(['tquery.skymap', 'tquery.lensflare'], function(){
	var world	= tQuery.createWorld().boilerplate().pageTitle('#info').start();

	// tune initial camera position
	var cameraZ	= 2;
	world.removeCameraControls();	
	world.tCamera().position.z	= cameraZ;
	
	// add a skymap
	var skymap	= tQuery.createSkymap('skybox').addTo(world);

	// add some lensflare 
	tQuery.createLensFlare().addTo(world)
		.position(+1.5, 1, -3)
	tQuery.createLensFlare().addTo(world)
		.position(-1.5, 1, -3)
		
	var loader	= new THREE.BinaryLoader( true );
	loader.load( "walt/WaltHead_bin.js", function( tGeometry ){
		//createScene( tGeometry, cubeMaterial1, cubeMaterial2, cubeMaterial3 )
		console.log('tGeometry', tGeometry)
		// normalize the geometry
		var geometry	= tQuery(tGeometry)
			.computeAll().normalize().computeAll();
		// create the material
		var tMaterial	= new THREE.MeshBasicMaterial({
			color	: 0xB93B8F,
			envMap	: tQuery.createCubeTexture('skybox')
		});
		
		
		tQuery(geometry, tMaterial).addTo(world)
		for(var i = 0; i < 5; i++){
			tQuery(geometry, tMaterial).addTo(world)
				.positionX( i * 0.4)
				.positionZ(-i * 0.5)
			tQuery(geometry, tMaterial).addTo(world)
				.positionX(-i * 0.4)
				.positionZ(-i * 0.5)
		}
	});
	document.addEventListener("facetrackingEvent", function( event ) {
		if( event.detection !== 'CS' )	return;
		
		var normalizedX	= (event.x-160)/160;
		
		var angle	= Math.PI/3 * normalizedX + Math.PI/2;
		
		var tCamera	= world.tCamera();
		tCamera.position.x	= Math.cos(angle)*cameraZ;
		tCamera.position.z	= Math.sin(angle)*cameraZ;
		var target	= tQuery.createVector3(0,0,0);
		tCamera.lookAt(target);
	});	


	var videoInput	= document.getElementById('vid');
	var canvasInput = document.getElementById('compare');
	var htracker	= new headtrackr.Tracker();
	htracker.init(videoInput, canvasInput);
	htracker.start();
	
	// reset if space is pressed
	document.addEventListener('keydown', function(event){
		// only if the key is space
		if( event.keyCode !== ' '.charCodeAt(0) )	return;
		// reset the head tracker
		htracker.stop();
		htracker.start();		
	})
	
	var canvasView	= document.getElementById('overlay');	
	document.addEventListener("facetrackingEvent", function( event ) {
		// clear canvas
		var context = canvasView.getContext('2d');
		context.drawImage(videoInput, 0, 0, 320, 240);
		// once we have stable tracking, draw rectangle
		if( event.detection === 'CS' ){
			context.save();
			context.translate(event.x, event.y)
			context.rotate(event.angle - Math.PI/2);


			context.strokeStyle	= '#00CC00';
			context.strokeRect(Math.floor(-event.width/2), Math.floor(-event.height/2)
					, event.width, event.height);
			context.restore();
		}
	});	
});
</script></body>