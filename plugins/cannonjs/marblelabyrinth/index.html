<!doctype html><title>Minimal tQuery Page</title>
<script src="../../../build/tquery-bundle-require.js"></script>
<script src="../vendor/cannon.js/build/cannon.js"></script>
<script src="../tquery.world.cannonjs.js"></script>
<script src="../tquery.object3d.cannonjs.js"></script>
<body><div id="info" style="z-index: 2">
	Marble Labyrinth -
	<br/>
	<a href='https://github.com/mrdoob/three.js/' target='_blank'>three.js</a> with
	<a href='http://jeromeetienne.github.com/tquery/' target='_blank'>tQuery API</a> for 3D
	-
	<a href='http://schteppe.github.com/cannon.js/' target='_blank'>cannon.js</a> for physics
</div><script>
require(['tquery.poolball', 'tquery.shadowmap', 'tquery.deviceorientation'
	, 'tquery.webaudio', 'tquery.keyboard', 'tquery.skymap'], function(){
	var world	= tQuery.createWorld().boilerplate().start()
				.pageTitle('#info')
				.shadowMapEnabled(true)
/*
 * ### TODO
 * * if touch bumper, animation start, disable player controls
 *   * on animation end
 *   * goto start position
 *   * enable controls
 * * if touch bumper, animation start, disable player controls
 *   * on animation end
 *   * goto start position
 *   * enable controls
 */


	world.tCamera().position.z	= 15;

	world.removeCameraControls();

	world.tCamera().position.z	= 3;
	world.tCamera().position.y	= 1;
	world.tCamera().position.setLength(10)
	world.tCamera().lookAt(new THREE.Vector3(0,0,0))
	
	world.tCamera().position.z	= 3;
	world.tCamera().position.y	= 1;
	world.tCamera().position.setLength(3)
	world.tCamera().lookAt(new THREE.Vector3(0,0,0))

	// world.tCamera().position.z	= 1;
	// world.tCamera().position.y	= 10;
	// world.tCamera().position.setLength(10)
	// world.tCamera().lookAt(new THREE.Vector3(0,0,0))
	
	var cameraContainer	= tQuery.createObject3D().addTo(world)
	cameraContainer.add(world.tCamera())

	// enable webaudio
	WebAudio.isAvailable && world.enableWebAudio();
	var sounds	= null;
	if( true && WebAudio.isAvailable ){
		world.getWebAudio().volume(10)
		sounds	= {};
		sounds.impact	= tQuery.createSound().load('../../assets/sounds/kick.wav');
		sounds.bumper	= tQuery.createSound().load('../../assets/sounds/eatghost.mp3');
		sounds.goal	= tQuery.createSound().load('../../assets/sounds/eatpill.mp3');
	}
	var table	= tQuery.createObject3D().addTo(world)

	// put some lights
	tQuery.createAmbientLight().addTo(world).color(0x444444);
	tQuery.createDirectionalLight().addTo(world).position(6,6,6)
		.castShadow(true)
		.shadowDarkness(0.6)
		.shadowMap(512*4,512*4)
		.shadowCamera(12, -12, 8, -8, 0.1, 20)
		//.shadowCameraVisible(true)

	world.addCannonjs()
	var physicsWorld= world.cannonjsWorld();
	physicsWorld.gravity.set(0,-9.8,0);
	physicsWorld.solver.iterations = 10;

	var tileW	= 0.2;
	

if(false){
	var axis	= tQuery.createAxis().addTo(world)
				.translateY(1)	
	world.loop().hook(function(){
		var rotation	= axis.get(0).rotation;
		if( tQuery.keyboard().pressed('up') ){
			rotation.x	+= 0.01;
		}else if( tQuery.keyboard().pressed('down') ){
			rotation.x	-= 0.01;
		}
		if( tQuery.keyboard().pressed('left') ){
			rotation.z	+= 0.01;
		}else if( tQuery.keyboard().pressed('right') ){
			rotation.z	-= 0.01;
		}
		rotation.x	*= 0.99;
		rotation.z	*= 0.99;
		
		var matrix	= new THREE.Matrix4().setRotationFromEuler(rotation.clone().negate());
		var vector	= tQuery.createVector3(0,-9.81, 0)
		matrix.multiplyVector3(vector)
		//vector.applyMatrix4( matrix );
		physicsWorld.gravity.set(vector.x, vector.y, vector.z);
	});	
}


// sounds
// * granular sound for rolling
//   * depend on angularVelocity
// * impact sound
//   * volume depends on velocity
// ## step
// * draw maze on paper
// * convert it in js
// * sync chock with sound
// * sync with macbook orientation

var startPosition	= tQuery.createVector3(+22*tileW, 3, -13*tileW)
var ball	= (function(){
	var object3D	= tQuery.createPoolBall().addTo(world)
				.position(startPosition)
				.geometry()
					.scaleBy(3*tileW)
					.back()
				.castShadow(true)
				.receiveShadow(true)
				.addCannonjs()
					.addTo(physicsWorld)
					.back()
	object3D.cannonjs().body().addEventListener("collide",function(event){
		var body	= object3D.cannonjs().body();
		var speed	= body.velocity.norm();
		if( sounds ){
			var sound	= sounds.impact.play();
			sound.node.gain.value	= (speed*speed)/75;
		}
	});
	return object3D;
})();
if(true){
	var disablePlayerControls	= false;
	world.loop().hook(function(){
		if( disablePlayerControls )	return;
		ball.get(0).updateMatrixWorld();
		var ballPosition= ball.get(0).matrixWorld.getPosition();

		var worldPoint	= new CANNON.Vec3(ballPosition.x, ballPosition.y, ballPosition.z);
		var force	= new CANNON.Vec3(0,0,0);
		var dt		= 1/10;
		var length	= 1;
		if( tQuery.keyboard().pressed('up') ){
			force.z	= -length;
		}else if( tQuery.keyboard().pressed('down') ){
			force.z	= +length;
		}
		if( tQuery.keyboard().pressed('left') ){
			force.x	= -length;
		}else if( tQuery.keyboard().pressed('right') ){
			force.x	= +length;
		}
		var body	= ball.cannonjs().body();
		body.applyImpulse(worldPoint,force,dt);
	});	
}


	world.loop().hook(function(){
		cameraContainer.position( ball.position() )
	});

	// tQuery.createPoolBall().addTo(world)
	// 	.addCannonjs().addTo(physicsWorld)	
	// 		.position(0, 10, 1.3)
	// 		.back()
	// 	.castShadow(true)

	// var object	= tQuery.createAxis().addTo(world)
	// 	.translateY(1)
	// world.loop().hook(function(){
	// 	var orientation	= tQuery.deviceOrientation();
	// 	object.rotation( -orientation.angleY(), 0, orientation.angleZ() );
	// })

	var cursorX	= 0;
	var cursorZ	= 0;
	var cursor	= {
		moveTo	: function(gridX, gridZ){
			cursorX	= gridX;
			cursorZ	= gridZ;
			return this;
		},
		drawTo	: function(gridX, gridZ){
			if( gridX === cursorX ){
				addWallVert(gridX, cursorZ, gridZ)
				cursorZ	= gridZ;	
			}else if( gridZ === cursorZ ){
				addWallHori(gridZ, cursorX, gridX)
				cursorX	= gridX;
			}else	console.assert(false);
			return this;
		}
	}	

	// add the ground
	addGround(-35*tileW, -20*tileW, 35*tileW, 20*tileW)
	
	// TODO do an API moveTo(), drawTo()
	//addWall(-1, -1, 1, 1)
	// addWallHori(0, -5, 5)
	// addWallVert(-5, -5, 5)
	
	addGoalFlag(-3, 6);
	

	cursor	.moveTo(-25,-14)
		.drawTo(-25, 14)
	cursor	.moveTo(-25, 15)
		.drawTo( 25, 15)
	cursor	.moveTo( 25, 14)
		.drawTo( 25,-14)
	cursor	.moveTo( 25,-15)
		.drawTo(-25,-15)

	cursor	.moveTo(19,-14)
		.drawTo(19,-6)

	cursor	.moveTo(24,4)
		.drawTo(11,4)
	cursor	.moveTo(10, 4)
		.drawTo(10,-5)
	cursor	.moveTo(  9,-5)
		.drawTo(-12,-5)
	cursor	.moveTo(-13,-7)
		.drawTo(-13,-1)
	cursor	.moveTo(-20,-3)
		.drawTo(-17,-3)
	cursor	.moveTo(-21, 4)
		.drawTo(-21, 7)
	cursor	.moveTo(-16, 7)
		.drawTo(-16,10)


	cursor	.moveTo(-6,14)
		.drawTo(-6,3)
	cursor	.moveTo(-5,3)
	 	.drawTo(-1,3)
	cursor	.moveTo( 0,3)
		.drawTo( 0,8)
	
	cursor	.moveTo( 6,11)
		.drawTo( 9,11)
	
	addHole(16,-12)

	addHole( 13, 1)
	addHole(-11,-7)
	addHole(-22,-12)
	addHole(-13, 1)
	addHole(-22, 12)
	addHole(- 9, 12)
	addHole(  2,  8)
	addHole( 13,  9)


	function addWallHori(gridZ, gridX1, gridX2){
		if( gridX1 > gridX2 ){
			var tmp	= gridX2;
			gridX2	= gridX1;
			gridX1	= tmp;
		}
		var xMin	= gridX1*tileW - tileW/2;
		var zMin	= gridZ *tileW - tileW/2;
		var xMax	= gridX2*tileW + tileW/2;
		var zMax	= gridZ *tileW + tileW/2;
		return addWall(xMin, zMin, xMax, zMax)
	}
	function addWallVert(gridX, gridZ1, gridZ2){
		if( gridZ1 > gridZ2 ){
			var tmp	= gridZ2;
			gridZ2	= gridZ1;
			gridZ1	= tmp;
		}
		var xMin	= gridX *tileW - tileW/2;
		var zMin	= gridZ1*tileW - tileW/2;
		var xMax	= gridX *tileW + tileW/2;
		var zMax	= gridZ2*tileW + tileW/2;
		return addWall(xMin, zMin, xMax, zMax)
	}
	
	function addWall(x1, z1, x2, z2){
		var width	= Math.abs(x2 - x1);
		var height	= 0.5;
		var depth	= Math.abs(z2 - z1);
		var object3D	= tQuery.createCube(width,height,depth).addTo(table)
					.translateY(height/2)
					.translateX(x1 + width/2)
					.translateZ(z1 + depth/2)
					.addCannonjs({
						mass	: 0
					}).addTo(physicsWorld)
						.back()
					.setLambertMaterial()
						.color(0xcccccc)
						.map('../../assets/images/plywood.jpg')
						.back()
					.receiveShadow(true)
					.castShadow(true)
		object3D.get(0).material.map.repeat.x	= 10;
		object3D.get(0).material.map.repeat.Y	= 10;
		object3D.get(0).material.map.wrapS	= THREE.RepeatWrapping;
		object3D.get(0).material.map.wrapT	= THREE.RepeatWrapping;
		return object3D;
	}

	function addGround(x1, z1, x2, z2){
		var width	= Math.abs(x2 - x1);
		var depth	= Math.abs(z2 - z1);
		var object3D	= tQuery.createCube(width,1,depth).addTo(table)
					.translateY(-0.5)
					.translateX(x1 + width/2)
					.translateZ(z1 + depth/2)
					.addCannonjs({
						mass	: 0
					}).addTo(physicsWorld)
						.back()
					.setLambertMaterial()
						.color(0xffffff)
						.map('../../assets/images/plywood.jpg')
						.back()
					.receiveShadow(true)
					.castShadow(true)
		object3D.get(0).material.map.repeat.x	= 10;
		object3D.get(0).material.map.repeat.Y	= 10;
		object3D.get(0).material.map.wrapS	= THREE.RepeatWrapping;
		object3D.get(0).material.map.wrapT	= THREE.RepeatWrapping;
		return object3D;
	}
	
	function addHole(gridX, gridZ){
		var object3D	= tQuery.createSphere().addTo(world)
			.positionX(gridX * tileW)
			.positionZ(gridZ * tileW)
			.geometry()
				.scaleBy(3*tileW)
				.back()
			.castShadow(true)
			.receiveShadow(true)
			.setLambertMaterial()
				.map('../../assets/images/plywood.jpg')
				.color(0xaa22aa)
				.back()
			.addCannonjs({
					mass	: 0
				})
				.addTo(physicsWorld)
				.back()

		object3D.cannonjs().body().addEventListener("collide",function(event){
			console.log('bumpercollide')
			object3D.get(0).material.color.setHex(0xff2222);
			sounds && sounds.bumper.play();
			// init animation
			var animationDelay	= 1000;			
			disablePlayerControls	= true;
			var startAt	= tQuery.now() / 1000;
			var callback	= world.loop().hook(function(){
				var age		= tQuery.now()/1000 - startAt;
				var angle	= 2 * age * Math.PI * 2;
				var scale	= 0.7 + Math.sin(angle)*0.6;
				ball.scale(scale);
			});
			// setup timeout for deinit
			setTimeout(function(){
				ball.scale(1)
				world.loop().unhook(callback);
				disablePlayerControls	= false;
				ball.cannonjs().position(startPosition.x, startPosition.y, startPosition.z)
				sounds && sounds.bumper.play();
			}, animationDelay)
		});
	}
	
	function addGoalFlag(gridX, gridZ){
		var goalFlag	= tQuery.createPlane().addTo(world)
			.positionX(gridX * tileW)
			.positionY(0.01)
			.positionZ(gridZ * tileW)
			.geometry()
				.scaleBy(3*tileW)
				.rotateX(-Math.PI/2)
				.back()
			.receiveShadow(true)
			.setLambertMaterial()
				.map('images/checkerboard.jpg')
				.opacity(0.8)
				.transparent(true)
				.back()
			.addCannonjs({
					mass	: 0
				})
				.addTo(physicsWorld)
				.back()
		goalFlag.cannonjs().body().addEventListener("collide",function(event){
			console.log('Goal!!!')
			goalFlag.get(0).material.color.setHex(0xff2222);
			sounds && sounds.goal.play();
			// init animation
			var animationDelay	= 1000;			
			disablePlayerControls	= true;
			var startAt	= tQuery.now() / 1000;
			var callback	= world.loop().hook(function(){
				var age		= tQuery.now()/1000 - startAt;
				var angle	= 2 * age * Math.PI * 2;
				var scale	= 0.7 + Math.sin(angle)*0.6;
				ball.scale(scale);
			});
			// setup timeout for deinit
			setTimeout(function(){
				ball.scale(1)
				world.loop().unhook(callback);
				disablePlayerControls	= false;
				ball.cannonjs().position(startPosition.x, startPosition.y, startPosition.z)
				sounds && sounds.bumper.play();
			}, animationDelay)
		});
	}
});
</script></body>