<!doctype html><title>Minimal tQuery Page</title>
<script src="../../../build/tquery-bundle-require.js"></script>

<script src='../../checkerboard/tquery.checkerboard.js'></script>

<script src='../../grassground/tquery.grassground.js'></script>

<script src="../tquery.midikeytween.js"></script>

<script src="../tquery.minecraftchar.js"></script>
<script src="../tquery.minecraftchar.keyboard2.js"></script>
<script src="../tquery.camerafpscontrols.js"></script>

<script src="../tquery.animation.js"></script>
<script src="../tquery.animations.js"></script>

<script src="../tquery.spritesheet.js"></script>

<script src="../tquery.minecraftcharanimations.js"></script>
<script src="../tquery.minecraftcharheadanimations.js"></script>

<script src="../../simplemaze/tquery.simplemaze.js"></script>

<script src='../../fog/tquery.world.createfog.js'></script>
<script src='../../light/tquery.light.shadow.js'></script>

<body><script>
require(['tquery.pproc', 'tquery.skymap', 'tquery.keyboard', 'tquery.lensflare'], function(){
	var world	= tQuery.createWorld().boilerplate().start();

	// add post processing
	world.addEffectComposer()
		.sepia()
		.film(0.5, 0.25, 648, false)
		.vignette()
		.finish();

	world.tRenderer().shadowMapEnabled	= true;
	world.tRenderer().shadowMapSoft		= true;

	tQuery.createSkymap('skybox').addTo(world);
	
	//tQuery.createLensFlare().addTo(world).position(0, 1, -3)


	var character	= tQuery.createMinecraftChar().addTo(world);
	tQuery('mesh', character.object3D('root')).castShadow(true)

	tQuery.createAmbientLight().addTo(world)
		.color(0xFFFFFF);
	tQuery.createDirectionalLight().addTo(world)
		.position(1,1,-1).color(0xffffff).intensity(2);

	var lightDir1	= tQuery.createDirectionalLight().addTo(world)
		.position(-1, 2, 3)
		.color(0xffffff).intensity(4)
		.castShadow(true)
		.shadowDarkness(0.4)
		.shadowMap(512,512)
		.shadowCamera(2, -2, 2, -2, 0.1, 10)
		//.shadowCameraVisible(true)
	// for lightDir1 to follow character
	world.loop().hook(function(){
		var model	= character.object3D('root');
		var position	= model.get(0).position;
		lightDir1.get(0).target.position.copy(model.get(0).position)
		var delta	= tQuery.createVector3(-1,2,3);
		var position	= model.get(0).position.clone().addSelf(delta);
		lightDir1.position(position)
	})

	// create ground
	if( false ){
		tQuery.createCheckerboard({
			segmentsW	: 40,
			segmentsH	: 40
		}).addTo(world).scaleBy(40);		
	}
	if( true ){
		var ground	= tQuery.createGrassGround({
			textureRepeatX	: 20,
			textureRepeatY	: 20,
		}).addTo(world)
		.receiveShadow(true)
		.scale(40);
		ground.get(0).material.map.anisotropy = 4
	}	
	
	if( true ){
		// init bodyAnims
		var bodyAnims	= new tQuery.MinecraftCharAnimations(character);
		bodyAnims.start('run');
		// init headAnims
		var headAnims	= new tQuery.MinecraftCharHeadAnimations(character);
		headAnims.start('still');		
	}
	
	// initiate a spritesheet
	if( true ){
		var items	= new tQuery.Spritesheet({
			url	: 'images/items/items.png',
			imgW	: 256,
			imgH	: 256,
			spriteW	: 16,
			spriteH	: 16
		});
		// once the spritesheet is loaded, 
		items.bind('load', function(){
			var item	= 
			items.createMesh(2, 4)
				.addTo(character.parts.armR)
				.scaleBy(1/2)
				.position(0,-10/35,8/35)
				.rotation(Math.PI/2,Math.PI/2,Math.PI/4)
				.castShadow(true);
		});
	}
	
	if( true ){
		// TODO  handle collision
		// - walls vs aabb
		// - with computation of rebound
		var maze	= tQuery.createSimpleMaze({
			squareW	: 2,
			squareH	: 2,
			squareD	: 2,
			map	: [
				'*********',
				'*   *   *',
				'*  ** ***',
				'*       *',
				'***     *',
				'*       *',
				'*********'
			],
		}).addTo(world);		
	}



	// how to code a tracking camera
	// - a tracked object
	// - a target with a position relative to tracked object
	// - a camera position relative to tracker object
	
	// how to code keyboard controls
	// - related to camera position because it is was the user sees, 
	//   so what the user intend
	// - good algo is currently unknown
	// - go for the simple algo

	// to enable a tracking camera
	if( false ){
		var cameraControls	= tQuery.createCameraFpsControls({
			trackedObject	: character.object3D('root').get(0),
			tCamera		: world.tCamera(),
			debug		: false
		});
		world.setCameraControls(cameraControls)
		cameraControls.deltaCamera().position(0, 0.7, -0.07)
	}
	
	//////////////////////////////////////////////////////////////////////////
	// user controls on keyboard						//
	//////////////////////////////////////////////////////////////////////////
	var charKeyboard	= tQuery.createMinecraftCharKeyboard2({
		object3D	: character.object3D('root').get(0),
		lateralMove	: 'rotationY',
		//lateralMove	: 'strafe'
	})
/**
 * - a camera view does a tweening to the next
 * 
 * Do a basic state transition
 * - which state getter
 * - enter state fn to enter
 * - leave state fn to leave
 * - setup state setter
*/
/*
 * How to handle camera tweening
 * - do a control which is control the camera relative to another Object3D
 * - target is the absolute position where the camera should be
 * - and there is a tweening between both
*/
	document.addEventListener('keyup', function(event){
		var tCamera	= world.tCamera();
		if( event.which === '1'.charCodeAt(0) ){
			// destroy existing one if needed
			var controls	= world.getCameraControls();
			controls.destroy && controls.destroy();	
			// create new one
			var controls	= new THREEx.DragPanControls(tCamera);
			world.setCameraControls(controls);
			tCamera.position.z	= 3;
		}
		if( event.which === '2'.charCodeAt(0) ){
			// destroy existing one if needed
			var controls	= world.getCameraControls();
			controls.destroy && controls.destroy();	
			// create new one
			var controls	= tQuery.createCameraFpsControls({
				trackedObject	: character.object3D('root').get(0),
				tCamera		: world.tCamera(),
				debug		: false
			});
			world.setCameraControls(controls)
			controls.deltaCamera().position(0, 0.7, -0.07)
			charKeyboard.opts().lateralMove	= 'strafe';
		}
		if( event.which === '3'.charCodeAt(0) ){
			// destroy existing one if needed
			var controls	= world.getCameraControls();
			controls.destroy && controls.destroy();	
			// create new one
			var controls	= tQuery.createCameraFpsControls({
				trackedObject	: character.object3D('root').get(0),
				tCamera		: world.tCamera(),
				debug		: false
			});
			world.setCameraControls(controls)
			charKeyboard.opts().lateralMove	= 'rotationY';
		}
	});
	
if( true ){
// tquery.minecraftFpsControlsPlock
	// some compatibility layer for firefox/webkit
	navigator.pointer		= navigator.pointer || navigator.webkitPointer;
	navigator.pointer.islocked	= navigator.pointer.islocked || function(){ return navigator.pointer.isLocked; };

	document.addEventListener('keypress', function(event){
		if( event.charCode !== 'v'.charCodeAt(0) )	return;

		var domElement	= world.tRenderer().domElement;
		domElement.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);
		

		document.addEventListener('webkitfullscreenchange', function(){
			navigator.pointer.lock(document.body, function(){
				console.log("navigator.pointer.lock() succeed", navigator.pointer.islocked())
				document.addEventListener('mousemove', function(domEvent){
					var movementX	= domEvent.movementX !== undefined ? domEvent.movementX : domEvent.webkitMovementX;
					var movementY	= domEvent.movementY !== undefined ? domEvent.movementY : domEvent.webkitMovementY;
					console.assert( movementX !== undefined );
					console.assert( movementY !== undefined );

					//console.log("_onMouseMove", movementX, movementY);console.dir(domEvent);

					var model	= character.object3D('root').get(0);

					var speed	= 1 / 2028;	// nPixPerPI;
					var deltaAngle	= movementX * speed * Math.PI * 2;
					model.rotation.y-= deltaAngle;
					model.rotation.y%= 2*Math.PI;
					
					// change deltaTarget based on mouse movementY
					var deltaTarget	= cameraControls.deltaTarget();
					deltaTarget.get(0).position.y	-= movementY * 1/256;
					if( deltaTarget.get(0).position.y < 0 ){
						deltaTarget.get(0).position.y	= 0;
					}
					if( deltaTarget.get(0).position.y > 3 ){
						deltaTarget.get(0).position.y	= 3;
					}

				}, false);
			},function(){
				console.log("navigator.pointer.lock() failled")
			});
		}, false);
	});
}


	
})
</script></body>
