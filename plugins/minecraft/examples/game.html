<!doctype html><title>Minimal tQuery Page</title>
<script src="../../../build/tquery-bundle.js"></script>

<script src='../../checkerboard/tquery.checkerboard.js'></script>

<script src='../../grassground/tquery.grassground.js'></script>

<script src="../tquery.midikeytween.js"></script>

<script src="../tquery.minecraftchar.js"></script>

<script src="../tquery.animation.js"></script>
<script src="../tquery.animations.js"></script>

<script src="../tquery.spritesheet.js"></script>

<script src="../tquery.minecraftcharanimations.js"></script>
<script src="../tquery.minecraftcharheadanimations.js"></script>

<script src="../../../vendor/threex/THREEx.KeyboardState.js"></script>
<script src="../../keyboard/tquery.keyboard.js"></script>

<script src="../../simplemaze/tquery.simplemaze.js"></script>

<script src='../../fog/tquery.world.createfog.js'></script>
<script src='../../light/tquery.light.shadow.js'></script>

<script src="../../skymap/tquery.cubetexture.js"></script>
<script src="../../skymap/tquery.skymap.js"></script>

<body><script>
	var world	= tQuery.createWorld().boilerplate().start();

	
	world.tRenderer().shadowMapEnabled	= true;
	world.tRenderer().shadowMapSoft		= true;
		
	tQuery.createSkymap('skybox').addTo(world);

	var character	= tQuery.createMinecraftChar().addTo(world);
	tQuery('mesh', character.object3D('root')).castShadow(true)

	tQuery.createAmbientLight().addTo(world)
		.color(0xFFFFFF);
	tQuery.createDirectionalLight().addTo(world)
		.position(1,1,-1).color(0xffffff).intensity(2);

	var lightDir1	= tQuery.createDirectionalLight().addTo(world)
		.position(-1, 2, 3)
		.color(0xffffff).intensity(4)
		.castShadow(true)
		.shadowDarkness(0.8)
		.shadowMap(512*2,512*2)
		.shadowCamera(2, -2, 2, -2, 0.1, 10)
		.shadowCameraVisible(true)
	// for lightDir1 to follow character
	world.loop().hook(function(){
		var model	= character.object3D('root');
		var position	= model.get(0).position;
		lightDir1.get(0).target.position.copy(model.get(0).position)
		var delta	= tQuery.createVector3(-1,2,3);
		var position	= model.get(0).position.clone().addSelf(delta);
		lightDir1.position(position)
	})

	// create ground
	if( false ){
		tQuery.createCheckerboard({
			segmentsW	: 40,
			segmentsH	: 40
		}).addTo(world).scaleBy(40);		
	}
	if( true ){
		tQuery.createGrassGround({
			textureRepeatX	: 20,
			textureRepeatY	: 20,
		}).addTo(world)
		.receiveShadow(true)
		.scale(40);
	}	
	
	if( true ){
		// init bodyAnims
		var bodyAnims	= new tQuery.MinecraftCharAnimations(character);
		bodyAnims.start('run');
		// init headAnims
		var headAnims	= new tQuery.MinecraftCharHeadAnimations(character);
		headAnims.start('still');		
	}
	
	// initiate a spritesheet
	if( true ){
		var items	= new tQuery.Spritesheet({
			url	: 'images/items/items.png',
			imgW	: 256,
			imgH	: 256,
			spriteW	: 16,
			spriteH	: 16
		});
		// once the spritesheet is loaded, 
		items.bind('load', function(){
			var item	= items.createMesh(2, 4).scaleBy(1/2);
			item.position(0,-10/35,8/35)
				.rotation(Math.PI/2,Math.PI/2,Math.PI/4)
			item.addTo(character.parts.armR)
				.castShadow(true);
		});
	}
	
	if( false ){
		// TODO  handle collision
		// - walls vs aabb
		// - with computation of rebound
		var maze	= tQuery.createSimpleMaze({
			squareW	: 2,
			squareH	: 2,
			squareD	: 2,
			map	: [
				'*********',
				'*   *   *',
				'*  ** ***',
				'*       *',
				'***     *',
				'*       *',
				'*********'
			],
		}).addTo(world);		
	}



	// how to code a tracking camera
	// - a tracked object
	// - a target with a position relative to tracked object
	// - a camera position relative to tracker object
	
	// how to code keyboard controls
	// - related to camera position because it is was the user sees, 
	//   so what the user intend
	// - good algo is currently unknown
	// - go for the simple algo

	// to enable a tracking camera
if( true ){
// trackingobjectcontrols
// used to controls the camera to track the player	
	var tCamera		= world.tCamera();
	// var model	= character.object3D('root');
	// var controls	= tQuery.createTrackingControls(model, tCamera);
	// world.setCameraControls(controls);
	
	// controls.target()
	// controls.camera()


	var trackedObject	= character.object3D('root');


	tCamera.position.set(0,0,0)

	var deltaTarget		= tQuery.createSphere().addTo(trackedObject)
					.geometry().scaleBy(1/4).back()
					.position(0, 0, +2);
	var deltaCamera		= tQuery.createSphere().addTo(trackedObject)
					.geometry().scaleBy(1/4).back()
					//.position(0, 2, -3)
					//.position(0, 1, 0)
					.position(0, 0.7, -0.07)
	
	// this will be done when the cameraControl is set in world
	world.removeCameraControls()

	// this has to be done
	tQuery(tCamera).detach().addTo(deltaCamera);

	
	// in .update()
	world.loop().hook(function(delta, now){
		var delta	= deltaTarget.get(0).position.clone()
		delta.subSelf(deltaCamera.get(0).position);
		tCamera.lookAt(delta);
	});
}
	
	
	//////////////////////////////////////////////////////////////////////////
	// user controls on keyboard						//
	//////////////////////////////////////////////////////////////////////////
if(true){
// playermovecontrols
// used to move the player based on keyboard input
	var midiKey	= new tQuery.MidiKeyTween();
	// just debug
	// world.loop().hook(function(delta, now){
	// 	console.log("state", midiKey.state(), 'value', midiKey.value())
	// });
	// user control
	world.loop().hook(function(delta, now){
		var keyboard	= tQuery.keyboard();
		var model	= character.object3D('root').get(0);
		var action	= {
			left	: keyboard.pressed("left")	|| keyboard.pressed("a")	|| keyboard.pressed("a"),
			right	: keyboard.pressed("right")	|| keyboard.pressed("d"),
			up	: keyboard.pressed("up")	|| keyboard.pressed("w")	|| keyboard.pressed("z"),
			down	: keyboard.pressed("down")	|| keyboard.pressed("s"),
		}
		// keyboard handling
		
		if( false ){
			// lateral => rotation Y
			if( action.left )	model.rotation.y += 0.3 * delta * Math.PI * 2;
			if( action.right )	model.rotation.y -= 0.3 * delta * Math.PI * 2;			
		}else{
			// lateral => stafe
			var distance	= 0;
			if( action.left )	distance	= +2 * delta;
			if( action.right )	distance	= -2 * delta;
			if( distance ){
				var speed	= new THREE.Vector3(distance, 0, 0);
				var matrix	= new THREE.Matrix4().makeRotationY(model.rotation.y);
				matrix.multiplyVector3(speed);
				model.position.addSelf(speed);
			}			
		}

		var distance	= 0;
		if( action.up )		distance	= +2 * delta;
		if( action.down )	distance	= -2 * delta;
		if( distance ){
			var speed	= new THREE.Vector3(0, 0, distance);
			var matrix	= new THREE.Matrix4().makeRotationY(model.rotation.y);
			matrix.multiplyVector3(speed);
			model.position.addSelf(speed);
		}
	});	
}




if( true ){
	// some compatibility layer for firefox/webkit
	navigator.pointer		= navigator.pointer || navigator.webkitPointer;
	navigator.pointer.islocked	= navigator.pointer.islocked || function(){ return navigator.pointer.isLocked; };

	document.addEventListener('keypress', function(event){
		if( event.charCode !== 'v'.charCodeAt(0) )	return;

		var domElement	= world.tRenderer().domElement;
		domElement.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);
		

		document.addEventListener('webkitfullscreenchange', function(){
			navigator.pointer.lock(document.body, function(){
				console.log("navigator.pointer.lock() succeed", navigator.pointer.islocked())
				document.addEventListener('mousemove', function(domEvent){
					var movementX	= domEvent.movementX !== undefined ? domEvent.movementX : domEvent.webkitMovementX;
					var movementY	= domEvent.movementY !== undefined ? domEvent.movementY : domEvent.webkitMovementY;
					console.assert( movementX !== undefined );
					console.assert( movementY !== undefined );

					//console.log("_onMouseMove", movementX, movementY);console.dir(domEvent);

					var model	= character.object3D('root').get(0);

					var speed	= 1 / 2028;	// nPixPerPI;
					var deltaAngle	= movementX * speed * Math.PI * 2;
					model.rotation.y-= deltaAngle;
					model.rotation.y%= 2*Math.PI;
					
					// change deltaTarget based on mouse movementY
					deltaTarget.get(0).position.y	-= movementY * 1/256;
					if( deltaTarget.get(0).position.y < 0 ){
						deltaTarget.get(0).position.y	= 0;
					}
					if( deltaTarget.get(0).position.y > 3 ){
						deltaTarget.get(0).position.y	= 3;
					}

				}, false);
			},function(){
				console.log("navigator.pointer.lock() failled")
			});
		}, false);
	});
}


</script></body>
