<!doctype html><title>PongGL</title>
<script src="../../../build/tquery-bundle.js"></script>
<script src="../../requirejs/tquery.norequirejs.js"></script>

<script src="../../../vendor/threex/THREEx.KeyboardState.js"></script>
<script src="../../keyboard/tquery.keyboard.js"></script>

<script src="../../materials/tquery.meshlambertmaterial.js"></script>
<script src="../../materials/tquery.meshphongmaterial.js"></script>
<script src="../../materials/tquery.meshbasicmaterial.js"></script>

<script src="../../../vendor/three.js/ShaderExtras.js"></script>
<script src="../../../vendor/three.js/postprocessing/EffectComposer.js"></script>
<script src="../../../vendor/three.js/postprocessing/BloomPass.js"></script>
<script src="../../../vendor/three.js/postprocessing/DotScreenPass.js"></script>
<script src="../../../vendor/three.js/postprocessing/FilmPass.js"></script>
<script src="../../../vendor/three.js/postprocessing/MaskPass.js"></script>
<script src="../../../vendor/three.js/postprocessing/RenderPass.js"></script>
<script src="../../../vendor/three.js/postprocessing/SavePass.js"></script>
<script src="../../../vendor/three.js/postprocessing/ShaderPass.js"></script>
<script src="../../../vendor/three.js/postprocessing/TexturePass.js"></script>
<script src="../../pproc/tquery.effectcomposer.js"></script>

<script src='../../grassground/tquery.grassground.js'></script>

<script src="../../skymap/tquery.cubetexture.js"></script>
<script src="../../skymap/tquery.skymap.js"></script>

<body><script>
	// create a tQuery.World
	var world	= tQuery.createWorld().boilerplate().start();
	// no camera controls is needed
	//world.removeCameraControls();

//	tQuery.createSkymap('skybox').addTo(world);

	var ground	= tQuery.createGrassGround({
		textureUrl	: '../../grassground/images/grasslight-big.jpg',
		textureRepeatX	: 30,
		textureRepeatY	: 30,		
	}).addTo(world)
	ground.receiveShadow(true)
		.scaleBy(3, 2, 1)
		.translateY(-0.2)

	//world.addEffectComposer();
	////world.getEffectComposer().film(0.25, 0.25, 648, false).vignette();
	////world.getEffectComposer().verticalBlur(1.1)
	////world.getEffectComposer().horizontalBlur(1.1)
	//world.getEffectComposer().motionBlur(0.9);
	////world.getEffectComposer().screen();
	//world.getEffectComposer().film(0.25, 0.25, 648, false).vignette();
	//world.getEffectComposer().finish();

	// lights
	tQuery.createAmbientLight().addTo(world).color(0x444444);
	tQuery.createDirectionalLight().addTo(world).position(1,1,-1).color(0xFFFFFF);
	tQuery.createDirectionalLight().addTo(world).position(-1,1,1).color(0xffffff).intensity(1);

	// some constants for players
	var players	= { "right" : {}, "left": {} };	
	var racketW	= 0.25*0.5;
	var racketH	= 1.00*0.5;
	var racketRangeY= 2;
	// init each player
	Object.keys(players).forEach(function(playerId){
		var player	= players[playerId];
		// create tQuery.Object3D for a racket
		var url		= "../../physics/examples/images/rocks.jpg";
		var playerColor	= playerId === 'right' ? 0xffaacc : 0xccaaff;
		var object3d	= tQuery.createCube().addTo(world).scale(0.25,0.5,1).scaleBy(0.5)
				.setLambertMaterial().color(playerColor).map(url).back()
		object3d.translateX(1.3 * (playerId === "right" ? +1 : -1));
		player.object3d	= object3d;
	})
		
	// handle keyboard
	world.loop().hook(function(delta){
		var keyboard	= tQuery.keyboard();
		var speedY	= 2;
		if( keyboard.pressed('up') )	players['right'].object3d.translateZ(-delta*speedY);
		if( keyboard.pressed('down') )	players['right'].object3d.translateZ(+delta*speedY);
		if( keyboard.pressed('q') )	players['left'] .object3d.translateZ(-delta*speedY);
		if( keyboard.pressed('w') )	players['left'] .object3d.translateZ(+delta*speedY);
	})
	
	players['right'].onContact	= function(player, ball3d){
		player.object3d.get(0).material.color.setHex(0xFfffff*Math.random());
	};
	players['left'].onContact	= function(player, ball3d){
		player.object3d.get(0).material.color.setHex(0xFfffff*Math.random());
	};


	// constant for the field
	var fieldW	= 3;
	var fieldH	= 1.8;
	// constant for the ball
	var ballRadius	= 1/5;
	var angle	= Math.random()*Math.PI*2;
	var angle	= 0;
	var ballVelX	= Math.cos(angle)*0.03;
	var ballVelY	= Math.sin(angle)*0.03;
	// create a tQuery.Object3d for the ball
	var ball3d	= tQuery.createSphere().addTo(world).scaleBy(ballRadius)
			.setLambertMaterial().color(0x8800FF).map('../../assets/images/water.jpg').back()

	world.loop().hook(function(){
		// get ball position
		var position	= ball3d.get(0).position;
		// update position
		position.x	+= ballVelX;	
		position.y	+= ballVelY;
		// bounce the ball if it reach the border
		if( position.x < -fieldW/2 )	ballVelX	*= -1;
		if( position.x > +fieldW/2 )	ballVelX	*= -1;
		if( position.y < -fieldH/2 )	ballVelY	*= -1;
		if( position.y > +fieldH/2 )	ballVelY	*= -1;
		// get the boundaries
		position.x	= Math.max(position.x, -fieldW/2);
		position.x	= Math.min(position.x, +fieldW/2);
		position.y	= Math.max(position.y, -fieldH/2);
		position.y	= Math.min(position.y, +fieldH/2);
		// check collision with each player racket
		["right", "left"].forEach(function(playerId){
			// get tQuery.Object3D for this player
			var player	= players[playerId];
			var object3d	= player.object3d;
			// get the position in X and Y
			var racketX	= object3d.get(0).position.x;
			var racketY	= object3d.get(0).position.y;
			// test each ball boundary
			var mayHitLeft	= (position.x+ballRadius/2) >= (racketX-racketW/2);
			var mayHitRight	= (position.x-ballRadius/2) <= (racketX+racketW/2);
			var mayHitTop	= (position.y+ballRadius/2) >= (racketY-racketH/2);
			var mayHitBottom= (position.y-ballRadius/2) <= (racketY+racketH/2);
			// test if there is collision
			if( mayHitLeft && mayHitRight && mayHitTop && mayHitBottom ){
				// reaction of a collision
				ballVelX	*= -1;
				var deltaX	= racketW/2 + ballRadius/2;
				position.x	= racketX + (playerId === "right"? -deltaX : +deltaX);
				player.onContact && player.onContact(player, ball3d);
			}
		});
	});
	
	
	
</script></body>